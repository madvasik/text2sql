# Text-to-SQL аналитика для SQLite (Ollama / Mistral)

Интерактивное приложение для аналитики данных в SQLite: преобразует вопросы на естественном языке в SQL-запросы, выполняет их в безопасном read-only режиме и, при необходимости, автоматически визуализирует результаты.

## Быстрый старт

### Установка

```
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

### Запуск

```
streamlit run streamlit_app.py
```

Убедитесь, что Ollama запущен:

```
ollama serve
```

---

## Использование

1. **Выбор базы данных**

   * Укажите путь к SQLite-файлу (например, `Chinook_Sqlite.sqlite`)

2. **Выбор модели**

   * В боковой панели выберите LLM (например, `qwen3-coder:30b`, `solar`)

3. **Запрос**

   * Введите аналитический вопрос на естественном языке
   * Примеры:

     * `Показать долю клиентов по странам (топ 5)`
     * `Сколько треков в каждом жанре`
     * `Топ 10 самых длинных треков`

4. **Результат**

   * Сгенерированный SQL
   * Таблица результатов
   * (Опционально) визуализация
   * Пояснение запроса и краткий вывод

---

## Структура проекта

```
.
├── streamlit_app.py        # Streamlit UI и orchestration
├── text2sql/
│   ├── db.py               # Работа с SQLite, схема, read-only execution
│   ├── llm/
│   │   ├── base.py         # Базовый интерфейс LLM-провайдера
│   │   ├── ollama.py       # Провайдер Ollama
│   │   ├── provider.py     # Фабрика провайдеров
│   │   ├── prompts.py      # System prompts
│   │   └── __init__.py     # Public API (generate_sql, visualization, explain)
│   └── __init__.py
└── requirements.txt
```

---

## Ключевые возможности

### Text → SQL

* Генерация **одного корректного SQLite `SELECT`-запроса** из вопроса на естественном языке
* Поддержка локальных LLM через **Ollama** (по умолчанию) и **Mistral** (опционально)
* Строгие правила безопасности:

  * только `SELECT`
  * запрет `INSERT / UPDATE / DELETE / DROP / ALTER`
  * read-only доступ к базе
* Автоматическое ограничение результатов (`LIMIT`) для защиты UI и производительности

### Работа с базой данных

* Подключение к существующему SQLite-файлу
* Автоматическое извлечение **реальной схемы БД** (таблицы и колонки) напрямую из SQLite
* Схема используется как единственный источник истины для LLM (без «угадывания» колонок)

### Визуализация результатов

* Автоматическое решение, нужен ли график, через LLM
* Поддержка графиков:

  * столбчатые (bar)
  * линейные (line)
  * круговые (pie)
* Автоопределение осей (`x`, `y`) на основе результата SQL

### Пояснения и выводы

* Краткое объяснение, **что делает SQL-запрос** (2–3 предложения)
* Краткий аналитический вывод по результатам запроса
* Все пояснения генерируются LLM на основе:

  * исходного вопроса
  * SQL
  * preview результатов (ограниченное число строк)

---

## Архитектурные принципы

* **SQL-first**: сначала генерируется корректный SQL, затем принимается решение о визуализации
* **Schema-driven**: модель видит только реальную схему базы данных
* **Deterministic by default**: температура LLM = 0 для стабильных и воспроизводимых результатов
* **Безопасность по умолчанию**: невозможность модификации данных
